
# Algorithms and Formulas in Flat Field Correction Tool

## Overview
This document provides an in-depth explanation of the algorithms and mathematical formulas used in the **Flat Field Correction Tool**. The goal is to explain the processing pipeline in greater detail, focusing on the image correction process and the theory behind it. This document is intended for those who want to understand the core mathematics and the logic applied to improve the quality of images using flat field correction. For more information, refer to the [Wikipedia article on Flat-Field Correction](https://en.wikipedia.org/wiki/Flat-field_correction).

## Problem Statement
In scientific and industrial imaging, inconsistencies in illumination or imperfections in the sensor can lead to variations in the brightness and overall quality of an image. These variations can mask important details, introduce artifacts, and reduce the accuracy of measurements. Flat field correction is used to compensate for these inconsistencies to produce an even and accurate representation of the subject.

The primary goal is to correct the raw image (R) by removing the effect of sensor noise and illumination variations, using dark field (D) and flat field (F) images.

## Core Components and Formulas
Flat field correction consists of three key steps:

1. **Dark Field Subtraction**
2. **Flat Field Normalization**
3. **Gain Adjustment and Final Correction**

Each of these steps involves specific mathematical operations to ensure that artifacts and illumination variances are minimized.

### 1. Dark Field Subtraction
**Dark Field Image (D)** represents the sensor's response in the absence of light. The purpose of subtracting the dark field image is to eliminate noise introduced by the sensor itself (such as thermal noise or read noise). The formula for this step is:

$$
R' = R - D
$$

Where:
- **R**: Raw image
- **D**: Dark field image
- **R'**: Dark field corrected image

If **D** is not available, a synthetic version can be generated by reducing the brightness of the raw image to approximate the sensor's response in the absence of light.

This operation is similar to the technique described in the [Flat-Field Correction Wikipedia page](https://en.wikipedia.org/wiki/Flat-field_correction), which aims to reduce noise and improve overall image quality.

### 2. Flat Field Normalization
**Flat Field Image (F)** is used to correct for variations in illumination and optical imperfections in the imaging system. After the dark field subtraction, the image is normalized using the flat field image. This step involves calculating a gain factor that adjusts the brightness values to produce an evenly lit image.

The gain factor (G) is computed by using the average value of the flat field image minus the dark field:

$$
F' = F - D
$$

$$
m = 	ext{mean}(F')
$$

Where:
- **F**: Flat field image
- **D**: Dark field image
- **F'**: Flat field corrected for dark noise
- **m**: Mean value of **F'**

The mean value **m** represents the average brightness level that the corrected image should ideally achieve.

The concept here is to account for illumination inconsistencies by adjusting for the relative difference between the flat field and dark field images, ensuring that the overall illumination is uniform, as described in flat field correction literature.

### 3. Gain Adjustment and Final Correction
Using the mean value **m** and the flat field image minus the dark field (**F'**), we calculate a gain matrix **G** to adjust the raw image. The gain matrix is calculated as follows:

$$
G = rac{m}{F'}
$$

The gain matrix **G** is used to scale the dark-field corrected raw image **R'** to account for uneven illumination. The corrected image **C** is computed as:

$$
C = R' 	imes G
$$

Where:
- **G**: Gain matrix calculated using the mean and the flat field image
- **R'**: Dark-field corrected image
- **C**: Corrected image

To handle any divisions by zero, the flat field difference (**F'**) is adjusted to replace zero values with **NaN** before calculating **G**. This ensures that division by zero is avoided.

After applying the gain matrix, the image **C** is normalized to a range suitable for visualization. The normalization is performed as follows:

$$
C = rac{C - C_{\min}}{C_{\max} - C_{\min}}
$$

This step ensures that all pixel values are scaled between **0** and **1**, which are then multiplied by **255** to convert them to an 8-bit grayscale image for display purposes.

### Handling Edge Cases
- **Division by Zero**: When calculating the gain matrix, any zero values in **F'** are replaced with **NaN** to prevent division errors. After the correction, any **NaN** or infinite values in the corrected image are replaced with zeros.
- **Image Dimensions**: All images must have the same dimensions for the correction to work properly. This ensures pixel-wise operations can be carried out without errors.
- **Noise Handling**: Synthetic dark and flat field images are generated if actual ones are not available. For synthetic flat field generation, Gaussian noise is added, and a Gaussian filter is applied to create a smooth approximation.

## Synthetic Image Generation
### Dark Field Image Generation
The dark field image can be synthesized by reducing the brightness of the raw image to approximate the sensor's inherent noise. The generated dark image is computed by applying a brightness reduction factor, typically around **10%** of the original brightness.

This synthetic approach helps approximate the baseline noise level of the sensor, ensuring that it can still be used for correction when a real dark field is unavailable.

### Flat Field Image Generation
A synthetic flat field is generated by creating a uniform bright image with slight Gaussian noise to simulate realistic lighting variations. The synthetic flat field is then smoothed using a Gaussian filter to remove any sharp noise and achieve a more natural flat image.

The steps for synthetic flat field generation are:
1. Create an image with uniform pixel intensity (e.g., **220** for an 8-bit scale).
2. Add Gaussian noise with a small standard deviation to simulate realistic conditions.
3. Apply a Gaussian filter with a specified **sigma** value (e.g., **5**) to achieve a smooth result.

These steps replicate the effects of an evenly illuminated scene with minor imperfections, which is crucial for accurate correction as described in the [Wikipedia article](https://en.wikipedia.org/wiki/Flat-field_correction).

## Mathematical Summary
To summarize, the entire correction can be expressed with the following formula sequence:

1. **Dark Field Correction**:
   
   $$
   R' = R - D
   $$

2. **Flat Field Correction**:
   
   $$
   F' = F - D
   $$
   
   $$
   G = rac{	ext{mean}(F')}{F'}
   $$
   
   $$
   C = R' 	imes G
   $$

3. **Normalization**:
   
   $$
   C = rac{C - C_{\min}}{C_{\max} - C_{\min}} 	imes 255
   $$

## Conclusion
The flat field correction process effectively minimizes artifacts and inconsistencies in an image caused by uneven illumination and sensor noise. By leveraging dark and flat field images, the algorithm corrects the raw image to produce a result that accurately represents the scene.

This process is critical in fields requiring precise imaging, such as microscopy, astrophotography, and medical imaging, where accurate intensity measurements are crucial for analysis. The overall approach taken in this program is consistent with well-established methods, as explained in the [Wikipedia article on Flat-Field Correction](https://en.wikipedia.org/wiki/Flat-field_correction).

If you have further questions or wish to delve deeper into specific parts of the algorithm, feel free to explore the source code or reach out to the project maintainers.
